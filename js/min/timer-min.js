var t,TimerWidget,s,SettingsWidget,h,HistoryWidget,t,TimerWidget={settings:{timerSection:$("#timer"),changeSettingsButton:$("#change-settings"),startPomodoroButton:$("#start-pomodoro"),startShortBreakButton:$("#start-short-break"),startLongBreakButton:$("#start-long-break"),progressNotification:$("#progress-notification"),pausePlay:$("#pause-play"),runningTimer:"",timerBegin:0,timerCountdown:1500,timerCountdownStart:1500,timerStart:moment(),pomoCount:0,statement:$("#statement"),timerEnd:moment(),timerType:"",runningPauseTimer:"",pauseCounter:0,pauseStartMoment:moment(),pauseTime:$("#pause-time"),count:0,pauseCurrentMoment:moment(),pauseText:$("#pause-text"),canvas:0,ctx:0,W:0,H:0,degrees:0,new_degrees:0,difference:0,color:"#EE424E",bgcolor:"#18191B",textColor:"#979797",text:"",animation_loop:"",redraw_loop:"",degreeCalculation:.24,playpause:!0},init:function(){t=this.settings,this.bindUIActions(),TimerWidget.displayTimerFoyer(t.timerCountdown),t.canvas=$("#timer-animation")[0],t.ctx=t.canvas.getContext("2d"),t.W=t.canvas.width,t.H=t.canvas.height,TimerWidget.draw()},bindUIActions:function(){t.changeSettingsButton.on("click",function(){SettingsWidget.enterSettings()}),t.pausePlay.click(function(){$(this).toggleClass("paused")}),t.pausePlay.on("click",function(){TimerWidget.setPlayPause()}),t.startPomodoroButton.on("click",function(){h.currentTask=h.taskInput.val(),h.taskInput.addClass("hide"),$(this).addClass("hide"),t.progressNotification.removeClass("hide"),""!==h.currentTask?h.taskWritten.text(h.currentTask):h.taskWritten.text("Working Hard!"),h.taskWritten.removeClass("hide"),TimerWidget.cancelTimer(),t.timerSection.removeClass("hide"),t.timerType="pomo",t.timerCountdownStart=s.timerSetting,t.degrees=0,TimerWidget.startTimer(s.timerSetting,t.timerType)}),t.startShortBreakButton.on("click",function(){TimerWidget.cancelTimer(),t.timerType="short-break",t.timerCountdownStart=s.shortBreakSetting,t.degrees=0,TimerWidget.startTimer(s.shortBreakSetting,t.timerType)}),t.startLongBreakButton.on("click",function(){TimerWidget.cancelTimer(),t.timerType="long-break",t.timerCountdownStart=s.longBreakSetting,t.degrees=0,TimerWidget.startTimer(s.longBreakSetting,t.timerType)})},setPlayPause:function(){t.playpause=!t.playpause,t.playpause?(TimerWidget.cancelPauseTimer(),TimerWidget.startTimer(t.timerCountdown,t.timerType)):TimerWidget.pauseTimer()},pauseTimer:function(){t.timerEnd=moment(),clearInterval(t.runningTimer),HistoryWidget.storeLocally({description:h.currentTask,timeTaken:HistoryWidget.displayTimeTaken(t.timerBegin-t.timerCountdown),timeStarted:t.timerStart.format("h:mm:ss a"),timeEnded:t.timerEnd.format("h:mm:ss a"),id:t.timerEnd.format("x"),date:t.timerEnd.format("MMMM Do YYYY")}),h.historyData.removeClass("hide"),t.pauseText.removeClass("hide"),t.pauseCounter=0,t.pauseStartMoment=moment();var e=Math.floor(t.pauseCounter/60),i=t.pauseCounter%60;$("#pause-minute-display").text(TimerWidget.formatTime(e)),$("#pause-second-display").text(TimerWidget.formatTime(i)),t.runningPauseTimer=setInterval(TimerWidget.intervalTimerUp,1e3)},cancelTimer:function(e){t.timerEnd=moment(),clearInterval(t.runningTimer),t.timerCountdown=0,"pomo"===e&&(t.pomoCount+=1,h.taskArea.removeClass("hide")),t.statement.removeClass("hide"),t.statement.text(TimerWidget.chooseStatement(e))},startTimer:function(e,i){t.timerBegin=e,t.timerStart=moment(),t.timerCountdown=e,t.degreeCalculation=360/t.timerCountdownStart,t.statement.addClass("hide"),TimerWidget.displayTimer(t.timerCountdown),t.runningTimer=setInterval(TimerWidget.intervalTimer,1e3,i),h.historyEmptyState.addClass("hide")},chooseStatement:function(e){return"pomo"===e?t.pomoCount%4===0?"Take a long break!":"Take a short break!":"Back to work with you!"},intervalTimerUp:function(){t.pauseCurrentMoment=moment(),t.count=t.pauseCurrentMoment.diff(t.pauseStartMoment,"second");var e=Math.floor(t.count/60),i=t.count%60;$("#pause-minute-display").text(TimerWidget.formatTime(e)),$("#pause-second-display").text(TimerWidget.formatTime(i))},displayTimerFoyer:function(t){var e=Math.floor(t/60),i=t%60;$("#start-time").text(TimerWidget.formatTime(e)+":"+TimerWidget.formatTime(i))},cancelPauseTimer:function(){clearInterval(t.runningPauseTimer),t.degrees=t.new_degrees,HistoryWidget.storeLocally({description:"Interrupted!",timeTaken:HistoryWidget.displayTimeTaken(t.count),timeStarted:t.pauseStartMoment.format("h:mm:ss a"),timeEnded:t.pauseCurrentMoment.format("h:mm:ss a"),id:t.pauseCurrentMoment.format("x"),date:t.timerEnd.format("MMMM Do YYYY")}),t.pauseText.addClass("hide")},intervalTimer:function(e){t.timerCountdown>1?t.timerCountdown=t.timerBegin-Math.round((moment()-t.timerStart)/1e3):(TimerWidget.cancelTimer(e),h.historyData.removeClass("hide"),"short-break"===e||"long-break"===e?HistoryWidget.storeLocally({description:"Break Time",timeTaken:HistoryWidget.displayTimeTaken(t.timerBegin-t.timerCountdown),timeStarted:t.timerStart.format("h:mm:ss a"),timeEnded:t.timerEnd.format("h:mm:ss a"),id:t.timerEnd.format("x"),date:t.timerEnd.format("MMMM Do YYYY")}):HistoryWidget.storeLocally({description:h.currentTask,timeTaken:HistoryWidget.displayTimeTaken(t.timerBegin-t.timerCountdown),timeStarted:t.timerStart.format("h:mm:ss a"),timeEnded:t.timerEnd.format("h:mm:ss a"),id:t.timerEnd.format("x"),date:t.timerEnd.format("MMMM Do YYYY")})),TimerWidget.displayTimer(t.timerCountdown)},displayTimer:function(e){var i=Math.floor(e/60),a=e%60;$("#time").removeClass("hide"),$("#background-image").removeClass("tomato"),$("#minute-display").text(TimerWidget.formatTime(i)),$("#second-display").text(TimerWidget.formatTime(a)),$("#start-time").addClass("hide"),t.text=""+TimerWidget.formatTime(i)+":"+TimerWidget.formatTime(a),TimerWidget.draw()},formatTime:function(t){return 10>t?"0"+t:t},initAnimation:function(){t.ctx.closePath(),t.ctx.clearRect(0,0,t.W,t.H),t.ctx.beginPath(),t.ctx.strokeStyle=t.bgcolor,t.ctx.lineWidth=15,t.ctx.arc(t.W/2,t.H/2,100,0,2*Math.PI,!1),t.ctx.stroke(),t.ctx.closePath();var e=t.degrees*Math.PI/180;t.ctx.beginPath(),t.ctx.strokeStyle=t.color,t.ctx.lineWidth=15,t.ctx.arc(t.W/2,t.H/2,100,0-90*Math.PI/180,e-90*Math.PI/180,!1),t.ctx.stroke(),t.ctx.fillStyle=t.textColor,t.ctx.font="300 50px lato";var i=t.ctx.measureText(t.text).width;t.ctx.fillText(t.text,t.W/2-i/2,t.H/2)},draw:function(){void 0!==typeof t.animation_loop&&clearInterval(t.animation_loop),t.new_degrees=Math.round((t.timerCountdownStart-t.timerCountdown)*t.degreeCalculation),t.difference=t.degrees-t.new_degrees,t.animation_loop=setInterval(TimerWidget.animate_to,1e3/t.difference)},animate_to:function(){t.degrees===t.new_degrees?clearInterval(t.animation_loop):t.degrees<t.new_degrees?t.degrees++:t.degrees--,TimerWidget.initAnimation()}},s,SettingsWidget={settings:{timeInput:$("#time-input"),shortBreakInput:$("#short-break"),longBreakInput:$("#long-break"),saveButton:$("#save-settings"),cancelButton:$("#cancel-settings"),settingsSection:$("#settings"),timerSetting:1500,shortBreakSetting:300,longBreakSetting:1200},init:function(){s=this.settings,this.bindUIActions()},bindUIActions:function(){s.saveButton.on("click",function(){SettingsWidget.saveSettings()}),s.cancelButton.on("click",function(){SettingsWidget.exitSettings()})},saveSettings:function(){TimerWidget.cancelTimer(),s.timerSetting=60*s.timeInput.val(),s.shortBreakSetting=60*s.shortBreakInput.val(),s.longBreakSetting=60*s.longBreakInput.val(),SettingsWidget.exitSettings(),TimerWidget.displayTimerFoyer(s.timerSetting),$("#start-time").removeClass("hide"),h.taskInput.removeClass("hide"),t.startPomodoroButton.removeClass("hide"),t.progressNotification.addClass("hide"),h.taskWritten.addClass("hide"),$("#background-image").addClass("tomato"),$("#time").addClass("hide"),t.pausePlay.removeClass("paused"),t.playpause=!0,TimerWidget.cancelPauseTimer()},enterSettings:function(){s.settingsSection.removeClass("hide")},exitSettings:function(){s.settingsSection.addClass("hide"),t.timerSection.removeClass("hide")}},h,HistoryWidget={settings:{taskArea:$("#task-area"),taskInput:$("#task-input"),taskWritten:$("#task-written"),historyData:$("#history-data"),historyDataTable:$("#history-data-table"),historyEmptyState:$("#history-empty"),taskInputButton:$("#task-input-button"),data:JSON.parse(localStorage.getItem("taskData"))||{},clearHistory:$("#clear-history"),saveButton:$("#save-button"),taskSaveArea:$("#task-save-area"),cancelButton:$("#cancel-button"),currentTaskEdit:"",editTaskButton:$("#edit-task"),oldTaskInfo:"",exportButton:$("#export-table"),row:JSON.parse(localStorage.getItem("rowData"))||[],currentTask:"",dateArray:[]},init:function(){h=this.settings,this.bindUIActions(),$.each(h.data,function(t,e){HistoryWidget.addTask(e)}),$.isEmptyObject(h.data)?h.historyEmptyState.removeClass("hide"):(h.historyData.removeClass("hide"),h.historyEmptyState.addClass("hide"))},bindUIActions:function(){h.taskInput.keyup(function(e){13===e.which&&t.startPomodoroButton.click()}),h.clearHistory.on("click",function(){HistoryWidget.clearHistory()}),h.historyDataTable.on("click",".edit-task",function(){HistoryWidget.editTask(this.id)}),h.historyDataTable.on("focus",".history__task-description",function(){HistoryWidget.showSave($(this).attr("id"))}),h.cancelButton.on("mousedown",function(){h.cancelButton.data("mousedown",!0)}),h.cancelButton.on("mouseup",function(){h.cancelButton.data("mousedown",!1)}),h.historyDataTable.on("blur",".history__task-description",function(){h.cancelButton.data("mousedown")!==!0&&HistoryWidget.saveTask(h.currentTaskEdit)}),h.historyDataTable.on("keydown",".history__task-description",function(t){return 13===t.which&&($(this).blur(),HistoryWidget.saveTask(h.currentTaskEdit)),13!==t.which}),h.saveButton.on("click",function(){HistoryWidget.saveTask(h.currentTaskEdit)}),h.cancelButton.on("click",function(){HistoryWidget.cancelSave()}),h.historyDataTable.on("click",".edit-task",function(){HistoryWidget.editTask(this)}),h.exportButton.on("click",function(){HistoryWidget.exportTable()})},displayTimeTaken:function(t){var e=Math.floor(t/60),i=t%60;return TimerWidget.formatTime(e)+":"+TimerWidget.formatTime(i)},editTask:function(t){var e=$(t).attr("id");$("#task-"+e).focus()},cancelSave:function(){$("#"+h.currentTaskEdit).text(h.oldTaskInfo),HistoryWidget.hideSave()},showSave:function(t){h.oldTaskInfo=$("#"+t).text(),h.currentTaskEdit=t,h.taskSaveArea.removeClass("hide")},saveTask:function(t){var e=$("#"+t).parent().parent().attr("id");h.data[e].description=$("#"+h.currentTaskEdit).text(),localStorage.setItem("taskData",JSON.stringify(h.data));for(var i=0;i<h.row.length;i++)h.row[i].id===e&&(h.row[i].task=$("#"+h.currentTaskEdit).text(),localStorage.setItem("rowData",JSON.stringify(h.row)));HistoryWidget.hideSave()},hideSave:function(){h.taskSaveArea.addClass("hide")},clearHistory:function(){localStorage.clear(),h.data={},h.row=[],h.dateArray=[],$("#history-data-body").empty(),$("#history-data").addClass("hide"),$("#history-empty").removeClass("hide")},storeLocally:function(t){h.data[t.id]=t,localStorage.setItem("taskData",JSON.stringify(h.data)),h.row.push({task:t.description,"time started":t.timeStarted,"time ended":t.timeEnded,id:t.id,"time spent":t.timeTaken}),localStorage.setItem("rowData",JSON.stringify(h.row)),HistoryWidget.addTask(t)},exportTable:function(){var t=[{title:"Task",dataKey:"task"},{title:"Start Time",dataKey:"time started"},{title:"Stop Time",dataKey:"time ended"},{title:"Duration",dataKey:"time spent"}],e=new jsPDF("p","pt");e.autoTable(t,h.row),e.save("table.pdf")},addTask:function(t){var e={taskItem:"history__task-item",taskDescription:"history__task-description",taskTime:"history__task-time",taskStart:"history__task-start",taskEnd:"history__task-end",id:t.id,date:t.date};h.historyEmptyState.addClass("hide");var i=e.date;i=i.replace(/\s+/g,"-").toLowerCase(),$.inArray(e.date,h.dateArray)<=-1&&(h.dateArray.push(e.date),$("<div>",{"class":i}).prependTo($("#history-data-body")),$("<p>",{"class":"date-header",text:e.date}).appendTo($("."+i)),$("<div>",{"class":e.dateString+"-body"}).appendTo($("."+i)));var a=$("<div>",{"class":e.taskItem,id:e.id}).prependTo($("."+e.dateString+"-body"));$("<div>",{"class":e.taskTime,text:t.timeTaken,"data-label":"Duration"}).appendTo(a),$("<div>",{"class":"description-container",id:e.id+"-container","data-label":"Task"}).appendTo(a),$("<div>",{"class":e.taskDescription,text:t.description,id:"task-edit-"+t.id,contenteditable:"true"}).appendTo($("#"+e.id+"-container")),$("<button>",{"class":"edit-task",id:"edit-"+t.id,text:"Edit"}).insertAfter($("#task-edit-"+t.id)),$("<div>",{"class":e.taskStart,text:t.timeStarted,"data-label":"Start"}).appendTo(a),$("<div>",{"class":e.taskEnd,text:t.timeEnded,"data-label":"Stop"}).appendTo(a)}};$(document).ready(function(){SettingsWidget.init(),TimerWidget.init(),HistoryWidget.init()});